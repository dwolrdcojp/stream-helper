# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a 24/7 automated Twitch streaming service built with TypeScript and FFmpeg. The service streams video files directly to Twitch via RTMP without requiring OBS. It's designed for low resource usage (~30-50MB memory) and high uptime reliability.

**Preview Mode**: The service supports local preview mode where streams are output as HLS files and served via HTTP, allowing testing without going live on Twitch.

## Architecture

### Core Components

1. **Streamer** (`src/streamer.ts`): Manages FFmpeg child processes, builds FFmpeg command arguments for RTMP streaming (live mode) or HLS output (preview mode), handles hardware acceleration options (VideoToolbox/VAAPI)

2. **Playlist Manager** (`src/playlist.ts`): Scans video directory for supported formats, manages queue with loop/shuffle options, watches directory for new files using fs.watch

3. **Overlay Manager** (`src/overlay.ts`): Updates text file read by FFmpeg's drawtext filter for dynamic overlays showing current video name

4. **Health Monitor** (`src/monitor.ts`): Tracks uptime and error counts, implements exponential backoff retry logic, performs periodic health checks

5. **Config Loader** (`src/config.ts`): Loads configuration from .env file, provides defaults for all settings, validates required fields (Twitch stream key only required in live mode)

6. **Preview Server** (`src/preview-server.ts`): Lightweight HTTP server that serves HLS playlist and segments, includes embedded HTML video player with HLS.js

7. **Main Service** (`src/index.ts`): Orchestrates all components, implements streaming loop with error handling, handles graceful shutdown on SIGINT/SIGTERM

### Key Design Decisions

- **No external npm dependencies** for runtime (only built-in Node.js modules) to minimize footprint
- **ES modules** (type: "module") throughout the codebase
- **FFmpeg text overlay** uses `drawtext` filter with `reload=1` to read from dynamically updated file
- **Process management** via systemd (Linux) or launchd (macOS) for auto-restart and boot persistence
- **Exponential backoff** for retries to avoid hammering Twitch on connection failures

## Common Development Tasks

### Building and Testing

```bash
npm run build     # Compile TypeScript to dist/
npm run dev       # Run with tsx (no build needed)
npm run watch     # Auto-compile on changes
```

### Running Locally

**Preview Mode** (no Twitch key needed):
```bash
# Set PREVIEW_MODE=true in .env
npm run dev
# Open http://localhost:8080 in browser
```

**Live Mode**:
```bash
# Set PREVIEW_MODE=false and add TWITCH_STREAM_KEY in .env
npm run dev
```

### FFmpeg Command Structure

The service builds different FFmpeg commands based on mode:

**Live Mode** (`buildTwitchArgs`):
- Input: `-re` flag for real-time streaming, hardware acceleration flags if enabled
- Video: libx264 codec, configurable preset/bitrate/resolution, scale filter + drawtext overlay filter
- Audio: AAC codec, 44.1kHz stereo
- Output: FLV format to Twitch RTMP endpoint

**Preview Mode** (`buildPreviewArgs`):
- Same input/video/audio settings as live mode
- Output: HLS format with 2-second segments, auto-deletes old segments
- Writes to `preview/stream.m3u8` and `.ts` segment files

See `src/streamer.ts:buildFFmpegArgs()`, `buildTwitchArgs()`, and `buildPreviewArgs()` for implementation.

### Configuration

All settings in `.env` - see `.env.example` for available options. Configuration is loaded once at startup via `src/config.ts:loadConfig()`.

### Adding New Features

**New overlay fields**: Update `src/types.ts:OverlayData`, modify `src/overlay.ts:formatOverlayText()` to include new fields

**New video sources**: Extend `src/playlist.ts` to support additional input methods (URLs, playlists, etc.)

**Custom retry logic**: Modify `src/monitor.ts:getBackoffDelay()` for different backoff strategies

**Additional streaming platforms**: Extend `src/streamer.ts` to support multiple RTMP outputs

### Service Installation

Service files are templates in `services/` directory. The `scripts/install.sh` script dynamically generates platform-specific service files with correct paths and installs them to:

- macOS: `~/Library/LaunchAgents/com.stream.service.plist`
- Linux: `~/.config/systemd/user/stream.service`

### Debugging

Set `LOG_LEVEL=debug` in `.env` to see FFmpeg output and detailed health checks. Service logs go to `logs/service.log` when running as a service.

## File Organization

- `src/`: TypeScript source (ES modules, .ts extension)
- `dist/`: Compiled JavaScript (generated by tsc, .js extension)
- `videos/`: Video file directory (watched for changes)
- `preview/`: HLS output directory (preview mode only, auto-created)
- `logs/`: Service output logs
- `overlays/`: Text files for FFmpeg overlay filter
- `services/`: Service configuration templates
- `scripts/`: Installation and setup scripts

## TypeScript Configuration

- Target ES2022 with ES2022 modules
- Strict type checking enabled
- Source maps generated for debugging
- Output to `dist/` directory

## Important Notes

- The service requires FFmpeg to be installed and available in PATH
- Twitch stream key must never be committed to git (use .env, which is gitignored)
- Twitch stream key is only required when `PREVIEW_MODE=false` (validation skipped in preview mode)
- Hardware acceleration (VideoToolbox on macOS, VAAPI on Linux) significantly reduces CPU usage but may not work on all systems
- The playlist manager uses synchronous fs operations on startup but async watching during runtime
- FFmpeg stderr is used for progress output (not errors), so don't treat all stderr as errors
- Preview mode uses HLS with auto-deleting segments to minimize disk usage
- The preview server uses HLS.js for broad browser compatibility (works in Chrome, Firefox, Edge; Safari has native HLS support)
